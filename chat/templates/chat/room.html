{% extends "base.html" %} 

{% block content %}

<ul id='chat_log'>
    {% for chat in object.chatmessage_set.all %}
        <li>{{ chat.message }}</li>
    {% endfor %}
</ul>

<form id='form' method="POST"> {% csrf_token %}
    <div class="form-group">
        <label for="message">Message</label>
        <input class="form-control" id="chat_input" type="text" aria-describedby="messageHelp" placeholder="Enter message here" />
    </div>
    <div class="form-group">
        <button id="chat-message-submit" type="submit" class="btn btn-primary">Send</button>
    </div>
</form>

{% endblock %} 


{% block script %}

<script>
    var loc = window.location
    var wsStart = 'ws://'
    if (loc.protocol == 'https:'){
        wsStart = 'wss://'
    }

    var fromData = $("#form")
    var chatInput = $("#chat_input")
    var chatLog = $("#chat_log")
    var endpoint = wsStart + loc.host + loc.pathname

    var socket = new WebSocket(endpoint);

    socket.onmessage = function(e) {
        console.log('Messaged', e);
        chatLog.append("<li>" + e.data + "</li>")
    }
        

    socket.onopen =  function(e) {
        console.log('Opened', e);
        fromData.submit(function(event){
            event.preventDefault()
            var chatText = chatInput.val()
            var data = {
                'message': chatText
            }
            socket.send(JSON.stringify(data))
            fromData[0].reset()
        })
    }
    
    socket.onerror =  function(e) {
        console.log('error', e);
    }

    socket.onclose = function(e) {
        console.log('Closed', e);
    }

</script>

{% endblock %}